version: '3.4'

services:      

  openxds-repository-server:
    build:
      context: ../../.
    image: registry.nspop.dk/components/openxds:snapshot
    depends_on:
      - openxds-repository-db
      - openxds-repository-logs-db
    environment:
      # NXRG should be running locally on port 8060
      - XDS_REGISTRY_HOST=host.docker.internal
      - XDS_REGISTRY_PORT=8060
      - XDS_REGISTRY_URL=/nxrg/iti42
      - XDS_REPOSITORY_UNIQUE_ID=1.3.6.1.4.1.21367.2010.1.2.1125
      - XDS_HOME_COMMUNITY_ID=urn:oid:1.3.6.1.4.1.21367.2010.1.2.2045
      - XDS_DB_DIALECT=org.hibernate.dialect.MySQLDialect
      - XDS_DB_DRIVER=com.mysql.jdbc.Driver
      - XDS_DB_OPENXDS_URL=jdbc:mysql://openxds-repository-db:3306/openxds
      - XDS_DB_OPENXDS_USERNAME=openxds
      - XDS_DB_OPENXDS_PASSWORD=open123
      - XDS_DB_LOGS_URL=jdbc:mysql://openxds-repository-logs-db:3306/openxdslogs
      - XDS_DB_LOGS_USERNAME=logs
      - XDS_DB_LOGS_PASSWORD=logs123
      - XARGS=-Xmx128m -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=8110
      - XDS_LOG_LEVEL=DEBUG
    ports:
      - "8020:8020"
      - "8110:8110"
    volumes:
      - ./logs/repository:/logs/
    extra_hosts:
      - "host.docker.internal:host-gateway"
 
  openxds-repository-db:
    image: mariadb:10.1
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=openxds
      - MYSQL_USER=openxds
      - MYSQL_PASSWORD=open123
    volumes:
      - ../database/repository-data-db/01_openxds.sql:/docker-entrypoint-initdb.d/01_db.sql
      - ./my.cnf:/etc/mysql/my.cnf
  
  openxds-repository-logs-db:
    image: mariadb:10.1
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=openxdslogs
      - MYSQL_USER=logs
      - MYSQL_PASSWORD=logs123
    volumes:
      - ../database/log-db/01_openxdslogs.sql:/docker-entrypoint-initdb.d/db.sql
      - ./my.cnf:/etc/mysql/my.cnf
